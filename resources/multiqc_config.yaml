# Cleaned & Organized MultiQC config (v1.32) — ChIP-seq / ATAC-seq
# Explanations tuned to nf-core’s output docs style.

# === Report Metadata & Top-level Toggles ===
skip_versions_section: true
no_ai: true
title: "Chromatin Profiling MultiQC Report"

# === Output & Execution ===
make_data_dir: true
export_plots: false
show_empty: true

# === General Stats: Paired-end Collapse ===
table_sample_merge:
  "R1": ".R1"
  "R2": ".R2"

# === Ignore Patterns (infra / peak-calling outputs) ===
fn_ignore_dirs:
  - ".snakemake"
  - ".snakemake/*"
  - "HOMER"
  - "homer"
  - "kraken"

exclude_modules:
  - cutadapt
  - macs2
  - idr
  - homer
  - diffbind
  - csaw
  - chipseeker

fn_ignore_paths:
  - "*/macs2/*"
  - "*/cutadapt/*"

fn_ignore_files:
  - "*cutadapt*.log"
  - "*cutadapt_report.txt"
  - "*_peaks.xls"
  - "*_summits.bed"
  - "*_model.r"
  - "*.idr.log"
  - "*annotatePeaks*"
  - "*motifResults*"
  - "*homerResults*"
  - "*chipseeker*"
  - "*peak_annotation*"
  - "*_peakCounts.txt"
  - "*.frip.txt"
  - "*peak_regions*"

# === Sample Naming & Cleaning ===
prepend_dirs: false
dirs_depth: 1

sample_names_replace_regex: true
sample_names_replace:
  "\\.Q5DD$": ""
  "\\.Q5$": ""

# === Module-specific: Filename Cleaning (fn_clean_exts) ===
fastqc:
  fn_clean_exts:
    - "_fastqc.zip"
    - "_fastqc.html"
    - "/fastqc_data.txt"
    - ".fastq.gz"

fastq_screen:
  use_filename: true
  fn_clean_exts:
    - ".trim_screen.txt"
    - "_screen.txt"
    - ".fastq_screen.txt"

phantompeakqualtools:
  fn_clean_exts:
    - ".ppqt.txt"

picard:
  fn_clean_exts:
    - ".insert_size_metrics.txt"
    - ".markdup_metrics.txt"
    - ".duplication_metrics.txt"
    - ".MarkDuplicates.metrics.txt"
    - ".duplic"

samtools:
  fn_clean_exts:
    - ".bam.flagstat"
    - ".bam.idxstats"
    - ".bam.idxstat"

preseq:
  fn_clean_exts:
    - ".ccurve"

custom_data:
  encode_qc:
    file_format: "csv"
    sample_id: "SampleID"
    samples_name: "SampleID"
    section_name: "6. ENCODE Library QC"
    plot_type: "table"
    anchor: "encode_qc"

    pconfig:
      id: "encode_qc_table"

    general_stats: false
    metrics:
      MEAN_INSERT_SIZE: { title: "Mean IS", format: "{:,.1f}" }
      NRF:              { title: "NRF",     format: "{:.3f}" }
      PBC1:             { title: "PBC1",    format: "{:.3f}" }
      PBC2:             { title: "PBC2",    format: "{:.3f}" }

# Tell MultiQC where to find the file
sp:
  encode_qc:
    fn: "EncodeQC.txt"

# === Module Scanning & Split Rules ===
module_order:
  # 1) Inputs QC
  - fastqc:
      name: "1. Inputs QC — FastQC (Pre-trim)"
      path_filters_exclude:
        - "*.trim_fastqc.zip"

  # 2) Contamination & Taxonomy
  - fastq_screen:
      name: "2a. Contamination — FastQ Screen (Species)"
      path_filters:
        - "*FQscreen/*screen.txt"
  - fastq_screen:
      name: "2b. Contamination — FastQ Screen (Repeats)"
      path_filters:
        - "*FQscreen2/*screen.txt"
  - kraken:
      name: "2c. Contamination — Kraken (Taxonomic Classification)"

  # 3) Post-trim QC
  - fastqc:
      name: "3. Post-trim QC — FastQC (Post-trim)"
      path_filters:
        - "*.trim_fastqc.zip"

  # 4) Alignment QC
  - samtools:
      name: "4a. Alignment QC — Samtools (sorted)"
      path_filters:
        - "*sorted.bam.flagstat"
#        - "*sorted.bam.idxstats"
#        - "*sorted.bam.idxstat"
  - samtools:
      name: "4b. Alignment QC — Samtools (Q5)"
      path_filters:
        - "*Q5.bam.flagstat"
#        - "*Q5.bam.idxstats"
#        - "*Q5.bam.idxstat"
  - samtools:
      name: "4c. Alignment QC — Samtools (Q5DD)"
      path_filters:
        - "*Q5DD.bam.flagstat"
        - "*Q5DD.bam.idxstats"
        - "*Q5DD.bam.idxstat"

  # 5) Library Metrics
  - picard:
      name: "5a. Library Metrics — Picard Insert Size (sorted)"
      path_filters:
        - "*sorted.insert_size_metrics.txt"
  - picard:
      name: "5b. Library Metrics — Picard Insert Size (Q5DD)"
      path_filters:
        - "*Q5DD.insert_size_metrics.txt"
  - picard:
      name: "5c. Library Metrics — Picard MarkDuplicates"
      path_filters:
        - "*Q5.duplic"
        - "*Q5.markdup_metrics.txt"
        - "*Q5.duplication_metrics.txt"
        - "*Q5.MarkDuplicates.metrics.txt"

  # 6) Cross-correlation QC
  - phantompeakqualtools:
      name: "6. Cross-correlation — PPQT"

  - custom_data:
      id: encode_qc
      anchor: encode_qc
      name: "6. ENCODE Library QC"

  # 7) Library Complexity
  - preseq:
      name: "7. Library Complexity — Preseq (ccurve)"
      path_filters:
        - "*.ccurve"

  # 8) Genome-wide QC
  - deeptools:
      name: "8a. deepTools - Genome-wide"
      anchor: deeptools_core
      # Prevent this instance from parsing the profile tables
      path_filters_exclude:
        - "deeptools/TSS_profile.Q5DD.tab"
        - "deeptools/enhancer_profile.Q5DD.tab"

  # deepTools — TSS profile (only the TSS table)
  - deeptools:
      name: "8b. deepTools — TSS profile"
      anchor: deeptools_tss
      path_filters:
        - "deeptools/TSS_profile.Q5DD.tab"

  # deepTools — Enhancer profile (only the Enhancer table)
  - deeptools:
      name: "8c. deepTools — Enhancer profile"
      anchor: deeptools_enh
      path_filters:
        - "deeptools/enhancer_profile.Q5DD.tab"


# === removing module sections ===
remove_sections:
  - samtools-flagstat-pct
  - samtools-2_samtools-flagstat-pct
  - samtools-1_samtools-flagstat-pct
  - fastqc_per_sequence_quality_scores
  - fastqc_per_base_n_content
  - fastqc_sequence_duplication_levels
  - fastqc_status_checks
  - fastqc-1_fastqc_per_sequence_quality_scores
  - fastqc-1_fastqc_sequence_duplication_levels
  - fastqc-1_fastqc_status_checks

# === General Stats: Column Visibility ===
table_columns_visible:
  "mqc_1_inputs_qc_fastqc_pre_trim-percent_duplicates": false
  "mqc_1_inputs_qc_fastqc_pre_trim-percent_gc": false
  "mqc_2c_contamination_kraken_taxonomic_classification-pct_top_one": false
  "mqc_2c_contamination_kraken_taxonomic_classification-pct_top_n": false
  "mqc_2c_contamination_kraken_taxonomic_classification-pct_unclassified": false
  "mqc_3_post_trim_qc_fastqc_post_trim-percent_duplicates": false
  "mqc_3_post_trim_qc_fastqc_post_trim-percent_gc": false
  "mqc_3_post_trim_qc_fastqc_post_trim-avg_sequence_length": true
  "mqc_3_post_trim_qc_fastqc_post_trim-median_sequence_length": false
  "mqc_5a_library_metrics_picard_insert_size_sorted_insertsizemetrics-summed_median": false
  "mqc_5a_library_metrics_picard_insert_size_sorted_insertsizemetrics-summed_mean": false
  "mqc_5b_library_metrics_picard_insert_size_q5dd_insertsizemetrics-summed_median": false
  "mqc_5b_library_metrics_picard_insert_size_q5dd_insertsizemetrics-summed_mean": true

# === General Stats: Column Renames ===
table_columns_name:
  # 1. FastQC (Pre-trim)
  "mqc_1_inputs_qc_fastqc_pre_trim-percent_duplicates": "Dup% (pre)"
  "mqc_1_inputs_qc_fastqc_pre_trim-percent_gc": "GC% (pre)"
  "mqc_1_inputs_qc_fastqc_pre_trim-avg_sequence_length": "Read len (pre)"
  "mqc_1_inputs_qc_fastqc_pre_trim-median_sequence_length": "Median len (pre)"
  "mqc_1_inputs_qc_fastqc_pre_trim-percent_fails": "Fail% (pre)"
  "mqc_1_inputs_qc_fastqc_pre_trim-total_sequences": "Reads (pre)"

  # 2c. Kraken (Taxonomic Classification)
  "mqc_2c_contamination_kraken_taxonomic_classification-pct_top_one": "Kraken: Top-1 taxon %"
  "mqc_2c_contamination_kraken_taxonomic_classification-pct_top_n": "Kraken: Top-N taxa %"
  "mqc_2c_contamination_kraken_taxonomic_classification-pct_unclassified": "Kraken: Unclassified %"

  # 3. FastQC (Post-trim)
  "mqc_3_post_trim_qc_fastqc_post_trim-percent_duplicates": "Dup% (post)"
  "mqc_3_post_trim_qc_fastqc_post_trim-percent_gc": "GC% (post)"
  "mqc_3_post_trim_qc_fastqc_post_trim-avg_sequence_length": "Read len (post)"
  "mqc_3_post_trim_qc_fastqc_post_trim-median_sequence_length": "Median len (post)"
  "mqc_3_post_trim_qc_fastqc_post_trim-percent_fails": "Fail% (post)"
  "mqc_3_post_trim_qc_fastqc_post_trim-total_sequences": "Reads (post)"

  # 4a–4c. Samtools (sorted / Q5 / Q5DD)
  "mqc_4a_alignment_qc_samtools_sorted_flagstat-flagstat_total": "Reads (sorted)"
  "mqc_4a_alignment_qc_samtools_sorted_flagstat-mapped_passed": "Mapped (sorted)"
  "mqc_4a_alignment_qc_samtools_sorted_flagstat-mapped_passed_pct": "Mapped% (sorted)"

  "mqc_4b_alignment_qc_samtools_q5_flagstat-flagstat_total": "Reads (Q5)"
  "mqc_4b_alignment_qc_samtools_q5_flagstat-mapped_passed": "Mapped (Q5)"
  "mqc_4b_alignment_qc_samtools_q5_flagstat-mapped_passed_pct": "Mapped% (Q5)"

  "mqc_4c_alignment_qc_samtools_q5dd_flagstat-flagstat_total": "Reads (Q5DD)"
  "mqc_4c_alignment_qc_samtools_q5dd_flagstat-mapped_passed": "Mapped (Q5DD)"
  "mqc_4c_alignment_qc_samtools_q5dd_flagstat-mapped_passed_pct": "Mapped% (Q5DD)"

  # 5a. Picard Insert Size (sorted)
  "mqc_5a_library_metrics_picard_insert_size_sorted_insertsizemetrics-summed_median": "Median IS (sorted)"
  "mqc_5a_library_metrics_picard_insert_size_sorted_insertsizemetrics-summed_mean": "Mean IS (sorted)"

  # 5b. Picard Insert Size (Q5DD)
  "mqc_5b_library_metrics_picard_insert_size_q5dd_insertsizemetrics-summed_median": "Median IS (Q5DD)"
  "mqc_5b_library_metrics_picard_insert_size_q5dd_insertsizemetrics-summed_mean": "Mean frag len (Q5DD)"

  # 5c. Picard MarkDuplicates
  "mqc_5c_library_metrics_picard_markduplicates_mark_duplicates-PERCENT_DUPLICATION": "Dup% (Picard)"

# === Scientist-Focused Descriptions (nf-core style) ===
section_comments:
  # ── Overview ──────────────────────────────────────────────────────────────

  general_stats: >
    <b>General Statistics.</b> High-level snapshot of read quality and alignment.
    Key mapping metrics derive from <i>Samtools Flagstat</i> summaries:
    <b>Sorted</b> shows overall alignment success,
    <b>Q5</b> highlights high-confidence alignments (MAPQ ≥ 5),
    and <b>Q5DD</b> reflects the final unique, deduplicated reads.
    Use these to compare mapping retention and library complexity across samples.
    <i>Recommended:</i> ≥10–50 M usable reads [Q5DD]. See https://openomics.github.io/chrom-seek/ for pipeline documentation.

# ── FastQC (Pre-trimming) ──────────────────────────────────────────────────
  fastqc_sequence_counts: >
    **Sequence counts (pre-trimming).** Total read numbers before adapter and
    quality trimming. High counts reflect sequencing depth; large differences
    between samples may indicate uneven pooling or run yield variation.
    Use as a baseline to assess read retention after trimming.

  fastqc_per_base_sequence_quality: >
    **Per-base quality (pre-trimming).** Raw reads often show declining quality toward
    the 3′ end, especially on longer runs. Most bases should still exceed
    Phred Q20–30; sharp drops suggest early-cycle issues or reagent degradation.

  fastqc_per_base_sequence_content: >
    **Base composition (pre-trimming).** Unequal base frequencies at early cycles are
    expected from random priming or low-diversity barcodes. Persistent imbalance
    through the read indicates sequence bias or contamination.

  fastqc_per_sequence_gc_content: >
    **GC distribution (pre-trimming).** ATAC-seq libraries are GC-rich from promoter and
    enhancer bias; ChIP-seq GC reflects motif composition. Small shifts are expected,
    but strong multi-modality can indicate contamination or amplification bias.

  fastqc_sequence_length_distribution: >
    **Sequence length (pre-trimming).** Raw data from most sequencers have uniform read
    lengths (e.g., 50, 75, 100 bp). Any variability suggests prior trimming or
    mixed run configurations.

  fastqc_adapter_content: >
    **Adapter content (pre-trimming).** Adapter contamination is expected in raw data,
    particularly near 3′ ends. Effective trimming should remove these entirely.

  fastqc_overrepresented_sequences: >
    **Over-represented sequences (pre-trimming).** Commonly include adapters, primers,
    or abundant transcripts. Persistent enrichment after trimming may reflect
    contamination or extreme amplification bias.

# ── FastQC-Post ─────────────────────────────────────────────────────────────────

  fastqc-1_fastqc_sequence_counts: >
    **Sequence counts (post-trimming).** Reads remaining after adapter and
    quality trimming. Typically >90 % of raw reads are retained; substantial
    loss suggests over-trimming or poor initial quality. Compare to pre-trim
    totals to gauge trimming efficiency and data recovery.

  fastqc-1_fastqc_per_base_sequence_quality: >
    **Per-base quality (post-trimming).** After trimming, all positions should retain
    Phred scores >30. A gradual decline near read ends is typical; abrupt drops
    may suggest over-trimming or low-quality cycles.

  fastqc-1_fastqc-1_per_base_sequence_content: >
    **Per-base sequence content (post-trimming).** After adapter removal, mild base
    composition bias often remains, especially in ATAC-seq and ChIP-seq libraries
    where enrichment near regulatory regions or motifs skews early cycles toward
    specific nucleotides. Overall base frequencies should stabilize across read
    length; strong or persistent imbalance may indicate contamination, incomplete
    trimming, or library-specific sequence bias.

  fastqc-1_fastqc_per_sequence_gc_content: >
    **GC distribution (post-trimming).** ATAC-seq libraries are GC-rich from promoter and
    enhancer bias; ChIP-seq GC reflects motif composition. Small shifts are expected,
    but strong multi-modality can indicate contamination or amplification bias.

  fastqc-1_fastqc_per_base_n_content: >
    **Per-base N content (post-trimming).** Represents the fraction of undetermined bases
    (“N”) at each position. After trimming, this should remain near zero across
    all cycles; elevated N content suggests poor signal quality or sequencing
    artifacts that trimming could not correct.

  fastqc-1_fastqc_sequence_length_distribution: >
    **Sequence length (post-trimming).** Read lengths should match the expected insert
    size after trimming. Variable lengths indicate adapter trimming or merged
    read pairs; extreme short reads may have been over-trimmed.

  fastqc-1_fastqc_adapter_content: >
    **Adapter content (post-trimming).** Adapter presence should be near zero after
    trimming. Residual adapter peaks suggest incomplete trimming or short inserts
    where read-through occurs.

  fastqc-1_fastqc_overrepresented_sequences: >
    **Over-represented sequences (post-trimming).** None should exceed 1 % after
    trimming. Matches to adapters, primers, or abundant transcripts can reveal
    contamination or over-amplification.

  # ── FastQ Screen ──────────────────────────────────────────────────────────
  fastq_screen: >
    **FastQ Screen — Species.** Reports reads mapping to a panel of reference
    genomes; for mammals this panel contains only human and mouse. Cross-mapping
    between these two species is common and usually benign. Persistent bacterial
    hits may signal tagmentation-reagent contamination — often from Tn5
    preparation — or environmental carryover.
    
  fastq_screen-1: >
    **FastQ Screen — Repeats.** Highlights repetitive and ribosomal content that reduces
    unique mappability and can lower peak-calling sensitivity, usually reflecting poor
    tagmentation efficiency in ATAC-seq or a weak/imprecise immunoprecipitation (IP) in ChIP-seq.

  # ── Kraken ────────────────────────────────────────────────────────────────
  kraken-top-n: >
    **Kraken — Taxonomic composition.** Provides species-level classification.
    Closely related mammalian genomes can be misassigned; focus on unexpected
    bacterial or fungal taxa. Frequent hits like *E. coli* or *Tn5 source species*
    suggest reagent contamination rather than true biological content.

  # ── Samtools Flagstat ─────────────────────────────────────────────────────
  samtools-flagstat: >
    **Flagstat (sorted).** Alignment-level metrics before any MAPQ filtering or
    deduplication. Summarizes total, mapped, and duplicate reads. Aim for
    ≥ 70–80 % mapped reads; high duplication at this stage reduces the fraction of
    ultimately usable signal.
  
  samtools-1_samtools-flagstat: >
    **Flagstat (Q5).** *Q5 = MAPQ ≥ 5.* Filters low-confidence alignments; expect
    slight read loss but improved mapping precision.

  samtools-2_samtools-flagstat: >
    **Flagstat (Q5DD).** *Q5DD = MAPQ ≥ 5 + deduplication.* Focuses on unique,
    confidently mapped reads for downstream use. **ENCODE** recommends at least
    **10–20 M usable reads for TF ChIP-seq**, **20–40 M for histone ChIP-seq**, and
    **≥ 50 M for ATAC-seq** to ensure robust signal and peak reproducibility.

  # ── Samtools Idxstats ─────────────────────────────────────────────────────
    
  samtools-2_samtools-idxstats: >
    **Idxstats — Chromosome counts (Q5DD).** ATAC-seq and ChIP-seq rarely differ biologically
    at the chromosome level; large imbalances usually reflect sequencing depth or
    alignment issues, not biology.
    
  samtools-2_samtools-idxstats-xy-counts: >
    **XY counts (Q5DD).** Shows read coverage for sex chromosomes. Use this plot to confirm sample sex, as consistent
    X/Y imbalances reflect expected biological differences.

  # ── Picard ────────────────────────────────────────────────────────────────
  picard-insertsize: >
    **Insert Size (sorted).** Aligned, before filtering. ATAC-seq should display nucleosome ladders
    (~150/300/450 bp), with the **~150 bp mononucleosome peak**
    usually the most abundant. ChIP-seq shows a broader fragmentation profile. A spike near 100 bp suggests
    **adapter dimers** or primer artifacts, while broad or irregular shapes indicate mixed fragment quality.
    ATAC-seq libraries often show a clear ~10 bp periodicity due to DNA helical structure and Tn5 insertion
    preferences, especially around phased nucleosomes. Standard sonication-based ChIP-seq typically does not
    show this pattern, though Tn5-based methods (e.g., ChIPmentation or CUT&Tag) may display a weaker version.

  picard-1_picard-1-insertsize: >
    **Insert Size (Q5DD).** Aligned, after all filtering. Cleaner, post-filter distribution mirroring the sorted profile.
    In ATAC-seq, the **~150 bp mononucleosome peak** should remain the most abundant.
    Adapter-dimer peaks should be absent, and broad shapes imply residual low-complexity fragments.
    ATAC-seq libraries often show a clear ~10 bp periodicity due to DNA helical structure and Tn5 insertion
    preferences, especially around phased nucleosomes. Standard sonication-based ChIP-seq typically does not
    show this pattern, though Tn5-based methods (e.g., ChIPmentation or CUT&Tag) may display a weaker version.
    

  picard-2_picard-2-markduplicates: >
    **Duplicates (Picard).** Aligned, after all filtering. High duplication lowers effective coverage.
    Typical ranges: **ATAC ~20–50 %**, **ChIP ~10–30 %**; >60 % implies over-amplification
    or limited library complexity.

  # ── Preseq ────────────────────────────────────────────────────────────────
  preseq: >
    **Preseq.** Projects how many additional unique reads deeper sequencing would add.
    Flat curves = low complexity, don't need as much sequencing; rising curves = more depth is beneficial.

  # ── ppqt ────────────────────────────────────────────────────────────────
  phantompeakqualtools: >
    **Cross-correlation (PPQT).** Estimates signal-to-noise using strand cross-correlation.
    Good libraries have **NSC > 1.05** and **RSC > 0.8** (ENCODE guidance); lower scores
    suggest weak enrichment or noisy data.

  # ── deepTools ─────────────────────────────────────────────────────────────
  deeptools_core_deeptools_correlation: >
    **deepTools Correlation.** Shows Spearman correlation of genome-wide 25 bp bins. Replicates
    should cluster closely, while Input/IgG controls remain distinct. Spearman is used instead
    of Pearson to be more tolerant of global differences in peak height.

  deeptools_core_deeptools_fingerprint: >
    **deepTools Fingerprint.** Shows the cumulative distribution of aligned reads ranked by signal intensity.
    Strongly enriched libraries show a **rapid upward rise toward the right-hand side of the plot**, where the
    highest-signal regions accumulate; weak or background libraries follow a more **straight, diagonal** profile,
    as seen for Input/IgG controls. **Transcription factors** typically produce a sharper right-end rise due to
    concentrated high-intensity peaks, whereas **histone marks**—especially broad ones—show a more gradual rise
    because signal is distributed across wider genomic domains. See the
    [deepTools documentation on fingerprint plots](https://deeptools.readthedocs.io/en/latest/content/tools/plotFingerprint.html)
    for further details.

  deeptools_tss_read_distribution_profile_plot: >
    **TSS Enrichment.** Aggregate read coverage around transcription start sites.
    Strong, narrow central peaks reflect precise chromatin accessibility or binding.
    Flat or diffuse profiles imply weak signal or poor fragment size balance.
    <br><i>Note:</i> The x-axis ranges from 0 to 600 bins,
    representing −3 kb to +3 kb around the TSS.
    The midpoint (x = 300) marks the transcription start site.

  deeptools_enh_read_distribution_profile_plot: >
    **Enhancer Enrichment.** Aggregate read coverage around known enhancers. Enhancer
    list defined by Fantom5 (https://fantom.gsc.riken.jp/5/).
    Strong, narrow central peaks reflect precise chromatin accessibility or binding.
    Flat or diffuse profiles imply weak signal or poor fragment size balance.
    <br><i>Note:</i> The x-axis ranges from 0 to 600 bins,
    representing −3 kb to +3 kb relative to the enhancer center.
    The midpoint (x = 300) marks the enhancer midpoint.

  encode_qc: >
    **ENCODE Library QC.** NRF (non-redundant fraction), PBC1, and PBC2 summarise
    library complexity; higher values indicate reduced PCR bottlenecking.  
    For **ATAC-seq**, ENCODE recommends high library complexity with **NRF ≥ 0.9**
    and **PBC1 ≥ 0.9**; low complexity is a common cause of weak TSS enrichment.
    For **ChIP-seq**, recommended thresholds are **PBC1 ≥ 0.9** and **PBC2 ≥ 10**
    (especially for transcription-factor ChIP). Details available at:
    https://www.encodeproject.org/atac-seq/ and https://www.encodeproject.org/chip-seq/

report_section_order:
  encode_qc:
    after: preseq
